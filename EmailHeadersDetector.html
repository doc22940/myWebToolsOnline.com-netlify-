<!DOCTYPE html>
<html>
<head>
	<title>Email headers detector</title>
	<!-- metaTags -->
	<meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<meta name="author" content="" />
	<meta name="robots" content="index"/>

	<meta name="description" content=""/>
	<meta name="keywords" content=""/>

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <link rel="stylesheet" type="text/css" href="./css/base.css"/>
    <link rel='stylesheet' href='https://use.fontawesome.com/releases/v5.7.0/css/all.css' integrity='sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ' crossorigin='anonymous'>
    <style type="text/css">
    	.result{
    		list-style:none
    	}
    </style>
</head>
<body>
	<div id="import-header"></div>
	<div class="row d-flex justify-content-center">
		<main class="col-sm-7">
			<div class="card card-body">
				<div class="form-group">
				  <label for="text-input">Text</label>
				  <textarea class="form-control" id="text-input" onkeyup="analyze()" rows="5" placeholder="Copy here your e-mail headers."></textarea>
				</div>
				<div class="form-group d-flex justify-content-center">
				  <button type="button" class="btn btn-warning form-control" id="clearInput-button" onclick="reset()">Reset</button>
				</div>
			</div>
			<div class="card card-body" id="results">
			</div>
		</main>
		<div id="import-aside"></div>
	</div>
	<div id="import-footer"></div>
	<script type="text/javascript" src="./js/comun.js"></script>
	<script type="text/javascript">
		function reset() {
			document.getElementById('text-input').value = ""; 
			analyze(); 
		}
		function analyze() {
			let email = document.getElementById('text-input').value; 

			const headers = /(?<header>^[A-Z][a-zA-Z]*(?:-[A-Z][a-zA-Z]*)*: )(?:.*\n?){1,5}?(?=^[A-Z][a-zA-Z]*(?:-[A-Z][a-zA-Z]*)*: )/gm;

			let m;
			document.getElementById("results").innerHTML = "";
			//console.log(headers.exec(email))
			let ip = "Ip doesn't found."; 
			let domain = "domain doesn't found."
			let results = `<div class="card-body"><ul class="list-group">
							<h5 class="card-title">Headers: </h5>`;
			while ((m = headers.exec(email)) !== null) {
			    // This is necessary to avoid infinite loops with zero-width matches
			    if (m.index === headers.lastIndex) {
			        headers.lastIndex++;
			    }
			    let content = m[0].split(m.groups["header"])[1].replace("<","&lt;");

			    //console.log(m[0].split(m.groups["header"])[1]); 
			    results += `
			    <li class="result">
					<ul class="list-group row flex-row">
					  	<li class="list-group-item col-sm-2">
					  		${m.groups["header"]}
					  	</li>
					  	<li class="list-group-item col-sm-10">
					  		${content}
					  	</li>
					</ul>
				</li>`;
			    //console.log(m);

			    if (m.groups["header"] == "Received: ") {
			    	//content
			    	const ip_received = /(?:(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)|(?:(?:[0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|(?:[0-9a-fA-F]{1,4}:){1,7}:|(?:[0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|(?:[0-9a-fA-F]{1,4}:){1,5}(?::[0-9a-fA-F]{1,4}){1,2}|(?:[0-9a-fA-F]{1,4}:){1,4}(?::[0-9a-fA-F]{1,4}){1,3}|(?:[0-9a-fA-F]{1,4}:){1,3}(?::[0-9a-fA-F]{1,4}){1,4}|(?:[0-9a-fA-F]{1,4}:){1,2}(?::[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:(?:(?::[0-9a-fA-F]{1,4}){1,6})|:(?:(?::[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(?::[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(?:ffff(?::0{1,4}){0,1}:){0,1}(?:(?:25[0-5]|(?:2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(?:25[0-5]|(?:2[0-4]|1{0,1}[0-9]){0,1}[0-9])|(?:[0-9a-fA-F]{1,4}:){1,4}:(?:(?:25[0-5]|(?:2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(?:25[0-5]|(?:2[0-4]|1{0,1}[0-9]){0,1}[0-9])))/gm;
			    	let aux = ip_received.exec(content)
			    	//console.log(aux); 
			    	if(aux != null){
			    		ip = aux[0];
			    		const domain_ip_received = /[a-zA-Z0-9-_.]{1,253}\.[a-zA-Z]{2,6}/gm;
			    		aux = domain_ip_received.exec(content)
			    		if(aux != null)
			    			domain = aux[0];

			    	}
			    }

			}
			
			results += `</ul></div>`;

			received = `
						<div>
							<h5 class="card-title">Received information: </h5>
							<div class="row flex-row justify-content-around">
						  		<div class="alert alert-primary col-sm-3" role="alert">
						  			Ip: ${ip}
						  		</div>
						  		<div class="alert alert-primary col-sm-8" role="alert">
						  			Domain: ${domain}
						  		</div>
					  		</div>
						</div>`;



			document.getElementById("results").insertAdjacentHTML("beforeend", received);; 
			document.getElementById("results").insertAdjacentHTML("beforeend", results);; 




			//console.log(email); 
		}

	</script>
</body>
</html>